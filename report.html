<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo Report - Daily Task App</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2e2a94; padding-bottom: 20px; }
        .header h1 { color: #2e2a94; margin: 0; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .stat-card { background: linear-gradient(135deg, #2e2a94, #1e1a64); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2.5rem; font-weight: bold; display: block; }
        .stat-label { font-size: 1rem; opacity: 0.9; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #2e2a94; color: white; }
        .status-completed { color: #28a745; font-weight: bold; }
        .status-pending { color: #ffc107; font-weight: bold; }
        .status-in-progress { color: #007bff; font-weight: bold; }
        .status-hold { color: #fd7e14; font-weight: bold; }
        .status-rejected { color: #dc3545; font-weight: bold; }
        .status-to-be-started { color: #6c757d; font-weight: bold; }
        .no-data { text-align: center; color: #666; font-style: italic; padding: 40px; }
        .refresh-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 10px 0; }
        .refresh-btn:hover { background: #218838; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Todo Report</h1>
            <p id="reportInfo">Loading...</p>
            <button class="refresh-btn" onclick="loadReport()">ðŸ”„ Refresh Data</button>
        </div>
        
        <div class="stats" id="statsContainer">
            <!-- Stats will be loaded here -->
        </div>
        
        <div id="tableContainer">
            <!-- Table will be loaded here -->
        </div>
    </div>

    <script src="js/database.js"></script>
    <script>
        let currentUser = null;
        let todos = [];
        let users = [];
        let projects = [];
        let activeCollaborations = [];

        async function loadReport() {
            try {
                // Get URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const userId = urlParams.get('userId');
                const weekFilter = urlParams.get('week') || 'all';
                const typeFilter = urlParams.get('type') || 'both';
                
                if (!userId) {
                    document.getElementById('reportInfo').innerHTML = '<span style="color: red;">Error: No user ID provided</span>';
                    return;
                }

                // Load data from Firebase
                todos = await db.getTodos() || [];
                users = await db.getUsers() || [];
                projects = await db.getProjects() || [];
                activeCollaborations = await db.getActiveCollaborations() || [];
                
                currentUser = users.find(u => u.id == userId);
                if (!currentUser) {
                    document.getElementById('reportInfo').innerHTML = '<span style="color: red;">Error: User not found</span>';
                    return;
                }

                // Update report info
                document.getElementById('reportInfo').innerHTML = `
                    Generated: ${new Date().toLocaleString()}<br>
                    User: ${currentUser.username} (${currentUser.email})<br>
                    Filter: ${weekFilter === 'all' ? 'All Time' : weekFilter} | Type: ${typeFilter}
                `;

                // Generate report data
                const reportData = generateReportData(weekFilter, typeFilter);
                displayStats(reportData.stats);
                displayTable(reportData.todos);

            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('reportInfo').innerHTML = '<span style="color: red;">Error loading data</span>';
            }
        }

        function getUserTodos() {
            return todos.filter(todo => todo.userId === currentUser.id);
        }

        function getSharedTodos() {
            const myCollabs = activeCollaborations.filter(c => 
                c.user1Id === currentUser.id || c.user2Id === currentUser.id
            );
            const partnerIds = myCollabs.map(c => 
                c.user1Id === currentUser.id ? c.user2Id : c.user1Id
            );
            return todos.filter(todo => {
                const todoUser = users.find(u => u.id === todo.userId);
                return partnerIds.includes(todo.userId) && todoUser && todoUser.role !== 'admin';
            });
        }

        function filterTodos(todoList, weekFilter) {
            if (weekFilter === 'all') return todoList;
            
            const now = new Date();
            const currentDay = now.getDay();
            const diff = now.getDate() - currentDay;
            
            let startDate, endDate;
            switch(weekFilter) {
                case 'this-week':
                    startDate = new Date(now.setDate(diff));
                    endDate = new Date(now.setDate(diff + 6));
                    break;
                case 'last-week':
                    startDate = new Date(now.setDate(diff - 7));
                    endDate = new Date(now.setDate(diff - 1));
                    break;
                case 'next-week':
                    startDate = new Date(now.setDate(diff + 7));
                    endDate = new Date(now.setDate(diff + 13));
                    break;
                default:
                    return todoList;
            }
            
            return todoList.filter(todo => {
                const todoDate = new Date(todo.date);
                return todoDate >= startDate && todoDate <= endDate;
            });
        }

        function generateReportData(weekFilter, typeFilter) {
            let allTodos = [];
            
            if (typeFilter === 'my' || typeFilter === 'both') {
                allTodos = allTodos.concat(getUserTodos());
            }
            
            if (typeFilter === 'team' || typeFilter === 'both') {
                allTodos = allTodos.concat(getSharedTodos());
            }
            
            const filteredTodos = filterTodos(allTodos, weekFilter);
            const totalTodos = filteredTodos.length;
            const completedTodos = filteredTodos.filter(t => (t.status || 'pending') === 'completed').length;
            const pendingTodos = totalTodos - completedTodos;
            const completionRate = totalTodos > 0 ? Math.round((completedTodos / totalTodos) * 100) : 0;
            
            return {
                stats: { totalTodos, completedTodos, pendingTodos, completionRate },
                todos: filteredTodos
            };
        }

        function displayStats(stats) {
            document.getElementById('statsContainer').innerHTML = `
                <div class="stat-card">
                    <span class="stat-number">${stats.totalTodos}</span>
                    <span class="stat-label">Total Todos</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.completedTodos}</span>
                    <span class="stat-label">Completed</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.pendingTodos}</span>
                    <span class="stat-label">Pending</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${stats.completionRate}%</span>
                    <span class="stat-label">Completion Rate</span>
                </div>
            `;
        }

        function displayTable(todoList) {
            if (todoList.length === 0) {
                document.getElementById('tableContainer').innerHTML = '<div class="no-data">No todos found for the selected criteria</div>';
                return;
            }

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>Status</th>
                            <th>Project</th>
                            <th>Owner</th>
                            <th>Date Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${todoList.map(todo => {
                            const project = projects.find(p => p.id === todo.projectId);
                            const projectName = project ? project.name : 'Unknown Project';
                            const status = todo.status || 'pending';
                            const statusLabel = getStatusLabel(status);
                            const ownerName = todo.userId === currentUser.id ? 'Me' : getPartnerName(todo.userId);
                            return `
                                <tr>
                                    <td>${todo.text}</td>
                                    <td class="status-${status}">${statusLabel}</td>
                                    <td>${projectName}</td>
                                    <td>${ownerName}</td>
                                    <td>${todo.date}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('tableContainer').innerHTML = tableHTML;
        }

        function getStatusLabel(status) {
            const statusMap = {
                'to-be-started': 'To be started',
                'pending': 'Pending',
                'in-progress': 'In progress',
                'hold': 'Hold',
                'completed': 'Completed',
                'rejected': 'Rejected'
            };
            return statusMap[status] || 'Pending';
        }

        function getPartnerName(userId) {
            const user = users.find(u => u.id === userId);
            return user && user.role !== 'admin' ? user.username : 'Unknown';
        }

        // Load report on page load
        window.addEventListener('load', loadReport);
    </script>
</body>
</html>